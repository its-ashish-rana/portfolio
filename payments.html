<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - Support Ashish</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,600,700,800,900" rel="stylesheet">
    <link rel="stylesheet" href="css/scribbler-global.css">
    <link rel="stylesheet" href="css/scribbler-landing.css">
    <link rel="stylesheet" href="css/main.css">
    <style>
      .payments-container { max-width: 980px; margin: 40px auto; padding: 0 16px; }
      .card { background: var(--color-white, #fff); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 24px; margin-bottom: 20px; }
      .card h2 { margin-top: 0; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
      .upi-box { text-align: center; }
      .upi-qr { width: 240px; height: 240px; object-fit: contain; border-radius: 8px; background: #fafafa; border: 1px solid #eee; }
      .note { font-size: 0.9rem; color: #666; }
      .pay-buttons a { display: inline-block; margin-right: 10px; margin-bottom: 10px; }
      .paypal-container { text-align: center; }
      .back-link { margin: 16px 0; display: inline-block; }
      @media (max-width: 768px) {
        .upi-qr { width: 200px; height: 200px; }
      }
    </style>
</head>
<body>
  <nav class="header">
    <ul class="menu">
      <div class="menu__item toggle"><span></span></div>
      <li class="menu__item"><a href="index.html" class="link link--dark"><i class="fas fa-home"></i> Home</a></li>
      <li class="menu__item"><a href="timeline.html" class="link link--dark"><i class="fas fa-history"></i> Timeline</a></li>
      <li class="menu__item"><a href="projects.html" class="link link--dark"><i class="fas fa-project-diagram"></i> Projects</a></li>
      <li class="menu__item"><a href="payments.html" class="link link--dark"><i class="fas fa-credit-card"></i> Payments</a></li>
    </ul>
  </nav>

  <div class="payments-container">
    <h1 class="section__title" id="checkout-title">Support My Work</h1>
    <div id="product-card" class="card" style="display:none;">
      <h2 id="product-title" style="margin:0 0 6px 0;">Checkout</h2>
      <p class="note" id="product-subtitle" style="margin:0 0 8px 0;"></p>
      <div class="price" id="product-price" style="font-weight:800; font-size:1.4rem;"></div>
      <p class="note" id="product-note" style="margin-top:6px;">Complete the payment below to unlock your download.</p>
      <div id="post-upi-actions" style="margin-top:10px; display:none;">
        <a id="mark-paid" class="button" style="padding:10px 16px; background:#1e88e5; color:#fff; border-radius:6px; text-decoration:none;" href="#">I've completed the UPI payment</a>
        <p class="note" id="manual-warning" style="margin-top:6px; display:none;">Manual unlock is disabled for this product. Use PayPal to auto-unlock, or contact support with payment proof.</p>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2><i class="fab fa-stripe"></i> Stripe</h2>
        <p class="note">Redirects to a secure Stripe Checkout page.</p>
        <div class="pay-buttons">
          <a class="button" style="padding:10px 16px; background:#635bff; color:#fff; border-radius:6px; text-decoration:none;" href="#" id="stripe-checkout-link">Pay with Stripe</a>
        </div>
      </section>

      <section class="card paypal-container">
        <h2><i class="fab fa-paypal" style="color:#003087"></i> PayPal</h2>
        <p class="note">Use PayPal for international cards and balances.</p>
        <div id="paypal-button-container"></div>
      </section>

      <section class="card paypal-container">
        <h2><i class="fas fa-university" style="color:#0E50A1"></i> Razorpay (UPI)</h2>
        <p class="note">Recommended for UPI. Click to pay ₹<span id="rzp-amount">99</span>.</p>
        <button id="rzp-pay" class="button" style="padding:10px 16px; background:#0E50A1; color:#fff; border-radius:6px; border:0;">Pay via Razorpay UPI</button>
      </section>

      <section class="card upi-box">
        <h2>UPI</h2>
        <p class="note">Scan the QR or tap the UPI link on mobile.</p>
        <img class="upi-qr" id="upi-qr" src="" alt="UPI QR"/>
        <div style="margin-top:12px;">
          <a class="button" style="padding:10px 16px; background:#2e7d32; color:#fff; border-radius:6px; text-decoration:none;" id="upi-intent" href="#">Pay via UPI App</a>
        </div>
        <div class="app-links" style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <a id="paytm-link" class="button" style="padding:8px 12px; background:#02A7F0; color:#fff; border-radius:6px; text-decoration:none;" href="#">Pay on Paytm</a>
          <a id="phonepe-link" class="button" style="padding:8px 12px; background:#5F259F; color:#fff; border-radius:6px; text-decoration:none;" href="#">Pay on PhonePe</a>
          <a id="gpay-link" class="button" style="padding:8px 12px; background:#1A73E8; color:#fff; border-radius:6px; text-decoration:none;" href="#">Pay on GPay</a>
        </div>
        <p class="note" style="margin-top:8px;">Pay directly with UPI ID: <a id="upi-id-link" href="#" style="color:#0a66c2; text-decoration:underline;">6394697442@ptaxis</a></p>
        <p class="note" style="margin-top:8px;">Already paid via UPI? <a href="upi-claim.html">Submit your UPI reference</a> and we'll send the link.</p>
      </section>
    </div>

    <a class="back-link link link--dark" href="index.html"><i class="fas fa-arrow-left"></i> Back to Home</a>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
  <script src="js/scribbler.js"></script>
  <script>
    function getParam(name){ try { return new URL(window.location.href).searchParams.get(name); } catch(e){ return null; } }
    // Set your deployed Cloudflare Worker base URL below, e.g., https://your-subdomain.workers.dev
    var WORKER_BASE = '';
    // Stripe: Replace with your actual Checkout Session/Link
    (function(){
      var stripeCheckoutLink = document.getElementById('stripe-checkout-link');
      // Placeholder: replace with your real Stripe payment link or session redirect
      var checkoutUrl = 'https://buy.stripe.com/test_1234567890abcdef';
      stripeCheckoutLink.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = checkoutUrl;
      });
    })();

    // PayPal: verify on Cloudflare Worker and redirect to signed download URL
    if (window.paypal) {
      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
        createOrder: function(data, actions) {
          var price = getParam('price') || '5.00';
          return actions.order.create({ purchase_units: [{ amount: { value: price }, description: 'Purchase' }] });
        },
        onApprove: function(data, actions) {
          var product = getParam('product') || 'purchase';
          var expectedAmount = getParam('price') || '5.00';
          if (!WORKER_BASE) {
            // Fallback: client capture without verification
            return actions.order.capture().then(function(){ alert('Payment captured, but Worker not configured.'); });
          }
          return fetch(WORKER_BASE + '/paypal/verify', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ orderId: data.orderID, expectedAmount: expectedAmount, product: product })
          }).then(function(r){ return r.json(); }).then(function(json){
            if (json && json.ok && json.downloadUrl) {
              window.location.href = json.downloadUrl;
            } else {
              alert('Payment verification failed. Please contact support with your Order ID: ' + data.orderID);
            }
          }).catch(function(){ alert('Network error verifying payment. Please try again.'); });
        },
        onError: function(err) { console.error('PayPal error', err); alert('Payment failed. Please try again.'); }
      }).render('#paypal-button-container');
    }

    // UPI intent: replace with your actual UPI ID and suggested amount
    (function(){
      var upiId = '6394697442@ptaxis';
      var amount = getParam('price') || '100'; // INR
      var name = 'Ashish Rana';
      var product = getParam('product');
      var mrp = getParam('mrp');
      var note = (product === 'ebook') ? 'Software Engineer Guide Book' : 'Support donation';
      var tr = 'order-' + Math.random().toString(36).slice(2,10);
      var redirect = getParam('redirect');
      var upiIdLink = document.getElementById('upi-id-link');
      upiIdLink.textContent = upiId;
      var intent = 'upi://pay?pa=' + encodeURIComponent(upiId)
        + '&pn=' + encodeURIComponent(name)
        + '&tn=' + encodeURIComponent(note)
        + '&am=' + encodeURIComponent(amount)
        + '&cu=INR'
        + '&tr=' + encodeURIComponent(tr);
      var a = document.getElementById('upi-intent');
      a.setAttribute('href', intent);
      upiIdLink.setAttribute('href', intent);
      // App-specific deep links
      var paytmHref = 'paytmmp://pay?pa=' + encodeURIComponent(upiId)
        + '&pn=' + encodeURIComponent(name)
        + '&tn=' + encodeURIComponent(note)
        + '&am=' + encodeURIComponent(amount)
        + '&cu=INR'
        + '&tr=' + encodeURIComponent(tr);
      var phonepeHref = 'phonepe://pay?pa=' + encodeURIComponent(upiId)
        + '&pn=' + encodeURIComponent(name)
        + '&tn=' + encodeURIComponent(note)
        + '&am=' + encodeURIComponent(amount)
        + '&cu=INR'
        + '&tr=' + encodeURIComponent(tr);
      var gpayHref = 'tez://upi/pay?pa=' + encodeURIComponent(upiId)
        + '&pn=' + encodeURIComponent(name)
        + '&tn=' + encodeURIComponent(note)
        + '&am=' + encodeURIComponent(amount)
        + '&cu=INR'
        + '&tr=' + encodeURIComponent(tr);
      document.getElementById('paytm-link').setAttribute('href', paytmHref);
      document.getElementById('phonepe-link').setAttribute('href', phonepeHref);
      document.getElementById('gpay-link').setAttribute('href', gpayHref);
      var qrImg = document.getElementById('upi-qr');
      var qrApi = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=' + encodeURIComponent(intent);
      qrImg.setAttribute('src', qrApi);

      // Desktop notice: UPI links open only on mobile devices
      var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (!isMobile) {
        var noteEl = document.createElement('p');
        noteEl.className = 'note';
        noteEl.textContent = 'Tip: Open this page on your phone or scan the QR to pay via UPI.';
        document.querySelector('.upi-box').appendChild(noteEl);
      }

      // Product-specific header
      if (product) {
        var card = document.getElementById('product-card');
        var title = document.getElementById('product-title');
        var subtitle = document.getElementById('product-subtitle');
        var priceEl = document.getElementById('product-price');
        var postActions = document.getElementById('post-upi-actions');
        card.style.display = 'block';
        document.getElementById('checkout-title').textContent = 'Checkout';
        if (product === 'ebook') {
          title.textContent = 'Software Engineer Guide Book';
          subtitle.textContent = 'Reviewed by FANG/MANG engineers and IIT alumni';
        } else {
          title.textContent = 'Your Purchase';
          subtitle.textContent = '';
        }
        if (mrp && amount) {
          priceEl.innerHTML = '<s>₹' + mrp + '</s> ₹' + amount;
        } else if (amount) {
          priceEl.textContent = '₹' + amount;
        }

        // After UPI click, show info but disable manual unlock for ebook
        a.addEventListener('click', function(){
          setTimeout(function(){
            postActions.style.display = 'block';
            var warn = document.getElementById('manual-warning');
            if (product === 'ebook') {
              warn.style.display = 'block';
              document.getElementById('mark-paid').style.display = 'none';
            }
          }, 400);
        });

        // Mark as paid flow (only for non-ebook products)
        var markPaid = document.getElementById('mark-paid');
        markPaid.addEventListener('click', function(e){
          e.preventDefault();
          if (product === 'ebook') return; // guarded
          try {
            localStorage.setItem(product + '_paid', 'true');
          } catch(err) {}
          if (redirect) { window.location.href = redirect; }
        });
      }
    })();

    // Razorpay Checkout via Worker
    (function(){
      var btn = document.getElementById('rzp-pay');
      var amount = getParam('price') || '99';
      var product = getParam('product') || 'ebook';
      document.getElementById('rzp-amount').textContent = amount;
      if (!btn) return;
      btn.addEventListener('click', async function(){
        if (!WORKER_BASE) { alert('Server not configured.'); return; }
        try {
          const res = await fetch(WORKER_BASE + '/razorpay/order', {
            method: 'POST', headers: { 'content-type':'application/json' },
            body: JSON.stringify({ amount, currency: 'INR', notes: { product } })
          });
          const json = await res.json();
          if (!json.ok) { alert('Order creation failed'); return; }
          const order = json.order;
          const key = json.keyId;
          // Load Razorpay Checkout if not present
          if (!window.Razorpay) {
            await new Promise(function(resolve, reject){
              var s = document.createElement('script');
              s.src = 'https://checkout.razorpay.com/v1/checkout.js';
              s.onload = resolve; s.onerror = reject; document.body.appendChild(s);
            });
          }
          var rzp = new Razorpay({
            key,
            amount: order.amount,
            currency: order.currency,
            name: 'Software Engineer Guide',
            description: product,
            order_id: order.id,
            handler: async function (response) {
              try {
                const v = await fetch(WORKER_BASE + '/razorpay/verify', {
                  method: 'POST', headers: { 'content-type':'application/json' },
                  body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature,
                    expectedAmount: amount,
                    product
                  })
                });
                const j = await v.json();
                if (j && j.ok && j.downloadUrl) {
                  window.location.href = j.downloadUrl;
                } else {
                  alert('Verification failed. Please contact support.');
                }
              } catch(e){ alert('Network error verifying payment.'); }
            },
            prefill: {},
            notes: { product },
            theme: { color: '#0E50A1' }
          });
          rzp.open();
        } catch(e){ alert('Network error creating order.'); }
      });
    })();
  </script>
</body>
</html>
